import crypto from 'crypto';
import fs from 'fs';
import path from 'path';

/**
 * Vite plugin to generate CSP hashes for inline scripts
 * Extracts JSON-LD structured data and generates SHA-256 hash
 * Writes hashes to dist/csp-hashes.json for use in _headers generation
 */
export function cspHashPlugin() {
  return {
    name: 'csp-hash-generator',
    transformIndexHtml: {
      order: 'post',
      handler(html) {
        // Extract JSON-LD script content
        const jsonLdMatch = html.match(/<script type="application\/ld\+json">([\s\S]*?)<\/script>/);

        if (jsonLdMatch) {
          const scriptContent = jsonLdMatch[1];
          const hash = crypto.createHash('sha256').update(scriptContent).digest('base64');

          // Ensure dist directory exists
          const distDir = path.resolve(process.cwd(), 'dist');
          if (!fs.existsSync(distDir)) {
            fs.mkdirSync(distDir, { recursive: true });
          }

          // Write hash to file for _headers generation
          const hashData = {
            jsonLd: `'sha256-${hash}'`,
            timestamp: new Date().toISOString(),
            note: 'Auto-generated by vite-plugin-csp-hash.js during build',
          };

          fs.writeFileSync(
            path.join(distDir, 'csp-hashes.json'),
            JSON.stringify(hashData, null, 2)
          );

          console.log(`✅ Generated CSP hash: sha256-${hash}`);
        } else {
          console.warn('⚠️  No JSON-LD script found in HTML');
        }

        return html;
      },
    },
  };
}
